<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NBA Player Consistency Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { padding-top: 50px; }
        .results { margin-top: 20px; }
        #console {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
            color: #212529;
        }
        .progress {
            margin-top: 10px;
            margin-bottom: 10px;
            height: 25px;
        }
        .progress-bar {
            transition: width 0.1s ease;
        }
        .analysis-status {
            margin-bottom: 5px;
        }
        .player-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            display: inline-block;
        }
        .console-line {
            margin-bottom: 5px;
        }
        /* Print specific styles */
        @media print {
            body { padding-top: 0; }
            button, .no-print { display: none !important; }
            .card { border: 1px solid #ddd; margin-bottom: 20px; }
            .card-header { background-color: #f8f9fa; padding: 10px; font-weight: bold; }
            .card-body { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">NBA Player Consistency Analyzer</h1>
        
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <form id="analyzeForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Number of Games</label>
                                <input type="number" class="form-control" id="numGames" value="5" min="1" max="10">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Points Threshold</label>
                                <input type="number" class="form-control" id="pointsThreshold" value="15" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Rebounds Threshold</label>
                                <input type="number" class="form-control" id="reboundsThreshold" value="4" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Assists Threshold</label>
                                <input type="number" class="form-control" id="assistsThreshold" value="4" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Analyze Players</button>
                </form>
                
                <div id="analysisProgress" style="display: none;">
                    <div class="card mt-4">
                        <div class="card-header">Analysis Progress</div>
                        <div class="card-body">
                            <div id="statusMessages"></div>
                            
                            <div class="progress-status d-flex justify-content-between">
                                <span id="currentPlayerInfo">Processing: <span class="player-name" id="playerName">Initializing...</span></span>
                                <span id="progressCount">0/0 (0%)</span>
                            </div>
                            
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <div id="console"></div>
                        </div>
                    </div>
                </div>
                
                <div id="results" class="results" style="display: none;">
                    <div class="text-center mb-4">
                        <button id="downloadPdf" class="btn btn-success">
                            <i class="bi bi-file-pdf"></i> Download Results as PDF
                        </button>
                    </div>
                    
                    <div id="resultsContent">
                        <div class="card mt-3">
                            <div class="card-header">Results: Points Consistency</div>
                            <div class="card-body" id="pointsResults"></div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">Results: Rebounds Consistency</div>
                            <div class="card-body" id="reboundsResults"></div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">Results: Assists Consistency</div>
                            <div class="card-body" id="assistsResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('analyzeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Reset and show progress
            document.getElementById('analysisProgress').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('console').innerHTML = '';
            document.getElementById('statusMessages').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            
            // Collect form data
            const data = {
                num_games: document.getElementById('numGames').value,
                points_threshold: document.getElementById('pointsThreshold').value,
                rebounds_threshold: document.getElementById('reboundsThreshold').value,
                assists_threshold: document.getElementById('assistsThreshold').value
            };
            
            // Setup EventSource for Server-Sent Events
            const eventSource = new EventSource('/analyze?' + new URLSearchParams(data));
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Add message to console
                const consoleElement = document.getElementById('console');
                
                // Handle different message types
                if (data.type === 'progress') {
                    // Update progress bar
                    document.getElementById('progressBar').style.width = data.percentage.toFixed(1) + '%';
                    document.getElementById('progressCount').textContent = 
                        `${data.current}/${data.total} (${data.percentage.toFixed(1)}%)`;
                    document.getElementById('playerName').textContent = data.player;
                    
                    // Add to console (update last line if it's a progress update)
                    const progressLine = `Processing: [${data.bar}] ${data.percentage.toFixed(1)}% | Player ${data.current}/${data.total}: ${data.player}`;
                    
                    // Only keep the last progress message to avoid cluttering
                    const lines = consoleElement.innerHTML.split('\n');
                    if (lines.length > 0 && lines[lines.length - 1].includes('Processing:')) {
                        lines[lines.length - 1] = progressLine;
                        consoleElement.innerHTML = lines.join('\n');
                    } else {
                        consoleElement.innerHTML += progressLine + '\n';
                    }
                } 
                else if (data.type === 'results') {
                    // Display results
                    document.getElementById('results').style.display = 'block';
                    
                    eventSource.close();
                    
                    // Save the analysis data for PDF generation
                    window.analysisData = data;
                    
                    // Display each category
                    ['points', 'rebounds', 'assists'].forEach(category => {
                        const resultDiv = document.getElementById(`${category}Results`);
                        const threshold = category === 'points' ? data.thresholds.points : 
                                         (category === 'rebounds' ? data.thresholds.rebounds : data.thresholds.assists);
                        
                        resultDiv.innerHTML = `<h5>${data[category].length} players with ${threshold}+ ${category} in each of their last ${data.thresholds.games} games:</h5>`;
                        
                        if (data[category].length > 0) {
                            const list = data[category].map((player, index) => 
                                `<li>${player}</li>`
                            ).join('');
                            resultDiv.innerHTML += `<ol>${list}</ol>`;
                        } else {
                            resultDiv.innerHTML += 'No players found meeting this criteria';
                        }
                    });
                    
                    // Add completion message to console
                    consoleElement.innerHTML += '\nAnalysis complete!\n';
                    consoleElement.scrollTop = consoleElement.scrollHeight;
                }
                else {
                    // Add status messages
                    document.getElementById('statusMessages').innerHTML += 
                        `<div class="analysis-status">${data.message}</div>`;
                    
                    // Add to console
                    consoleElement.innerHTML += data.message + '\n';
                }
                
                // Scroll console to bottom
                consoleElement.scrollTop = consoleElement.scrollHeight;
            };
            
            eventSource.onerror = function(event) {
                console.error("EventSource error:", event);
                document.getElementById('console').innerHTML += "Error: Connection lost. Please try again.\n";
                eventSource.close();
            };
        });
        
        // PDF Export functionality
        document.getElementById('downloadPdf').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current date
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            
            // Define game count and thresholds for the report
            const data = window.analysisData;
            const gameCount = data.thresholds.games;
            const pointsThreshold = data.thresholds.points;
            const reboundsThreshold = data.thresholds.rebounds;
            const assistsThreshold = data.thresholds.assists;
            
            // Set up document
            doc.setFontSize(18);
            doc.text('NBA Player Consistency Analysis', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Report generated on ${dateStr}`, 105, 22, { align: 'center' });
            doc.text(`Last ${gameCount} games | Points ≥ ${pointsThreshold} | Rebounds ≥ ${reboundsThreshold} | Assists ≥ ${assistsThreshold}`, 105, 27, { align: 'center' });
            
            // Add divider
            doc.setLineWidth(0.5);
            doc.line(20, 30, 190, 30);
            
            // Add Points section
            doc.setFontSize(14);
            doc.text(`Players with ${pointsThreshold}+ points in each of their last ${gameCount} games:`, 20, 40);
            
            doc.setFontSize(10);
            let yPos = 45;
            if (data.points.length === 0) {
                doc.text('No players found meeting this criteria', 25, yPos);
                yPos += 5;
            } else {
                data.points.forEach((player, index) => {
                    if (yPos > 280) {
                        doc.addPage();
                        yPos = 15;
                    }
                    doc.text(`${index + 1}. ${player}`, 25, yPos);
                    yPos += 5;
                });
            }
            
            // Add Rebounds section
            yPos += 5;
            doc.setFontSize(14);
            doc.text(`Players with ${reboundsThreshold}+ rebounds in each of their last ${gameCount} games:`, 20, yPos);
            yPos += 5;
            
            doc.setFontSize(10);
            if (data.rebounds.length === 0) {
                doc.text('No players found meeting this criteria', 25, yPos);
                yPos += 5;
            } else {
                data.rebounds.forEach((player, index) => {
                    if (yPos > 280) {
                        doc.addPage();
                        yPos = 15;
                    }
                    doc.text(`${index + 1}. ${player}`, 25, yPos);
                    yPos += 5;
                });
            }
            
            // Add Assists section
            yPos += 5;
            if (yPos > 260) {
                doc.addPage();
                yPos = 15;
            }
            
            doc.setFontSize(14);
            doc.text(`Players with ${assistsThreshold}+ assists in each of their last ${gameCount} games:`, 20, yPos);
            yPos += 5;
            
            doc.setFontSize(10);
            if (data.assists.length === 0) {
                doc.text('No players found meeting this criteria', 25, yPos);
            } else {
                data.assists.forEach((player, index) => {
                    if (yPos > 280) {
                        doc.addPage();
                        yPos = 15;
                    }
                    doc.text(`${index + 1}. ${player}`, 25, yPos);
                    yPos += 5;
                });
            }
            
            // Save the PDF
            doc.save('nba-player-consistency-analysis.pdf');
        });
    </script>
</body>
</html>
